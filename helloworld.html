<html>
    <head>
        <link rel="stylesheet" href="node_modules/jointjs/dist/joint.css" />
        <script src="node_modules/jquery/dist/jquery.js"></script>
        <script src="node_modules/lodash/index.js"></script>
        <script src="node_modules/backbone/backbone.js"></script>
        <script src="node_modules/jointjs/dist/joint.js"></script>
        <script src="node_modules/jointjs/dist/joint.shapes.fsa.js"></script>
        <script src="joint.shapes.quartz.js"></script>
    </head>
    <body>
        <div id="myholder"></div>
        <script type="text/javascript">

            var graph = new joint.dia.Graph;
        
            var paper = new joint.dia.Paper({
                el: $('#myholder'),
                width: 1000,
                height: 1000,
                model: graph,
                gridSize: 1
            });

            var quartz = (function() {
                var curX = 0;

                function addState(name) {
                    var textWidth = Math.max(name.length * 10, 100);
                    var state = new joint.shapes.quartz.State({
                        position: { x: curX, y: 30 },
                        size: { width: textWidth, height: 50 },
                        attrs: { text: { text: name } }
                    });

                    curX += textWidth + 20;
                    return state;
                }

                function State(id, name) {
                    this.id = id;
                    this.name = name;
                    this.linkedTo = []
                    this.superstate = undefined;
                }
                
                function StateGridInfo(state, x, y) {
                    this.state = state;
                    this.width = 1;
                    this.height = 1;
                }

                function FsmGridLayout() {
                    var grid = [[]];
                }

                var FsmDescription = function(inialState, statesInfo) {
                    var states = new Map();
                    var stateNamesToIds = new Map();

                    this.addState = function(id, name) {
                        states.set(id, new State(id, name));
                        stateNamesToIds.set(name, id);
                    };

                    function getState(idOrName) {
                        var id = idOrName;
                        if(typeof(idOrName) === 'string') {
                            id = stateNamesToIds.get(idOrName);
                        }

                        if(id === undefined || !states.has(id)) {
                            throw "Unknown state! idOrName = " + idOrName + ", id = " + id;
                        }

                        return states.get(id);
                    }

                    this.getCells = function() {
                        return Array.from(states.values());
                    };

                    this.getStates = function() {
                        return states;
                    }

                    function initialize() {
                        // First pass, add all the states
                        statesInfo.forEach(function(stateInfo) {
                            this.addState(stateInfo.id, stateInfo.name);
                        }, this);

                        // Second pass, process all the links and substates
                        statesInfo.forEach(function(stateInfo) {
                            state = states.get(stateInfo.id);
                            if('links' in stateInfo) {
                                stateInfo.links.forEach(function(link) {
                                    state.linkedTo.push(getState(link));
                                }, this);
                            }
                            if('substates' in stateInfo) {
                                stateInfo.substates.forEach(function(substate) {
                                    getState(substate).superstate = state;
                                }, this);
                            }
                        }, this);
                    }

                    // Constructor
                    initialize.apply(this);
                }

                return {
                    FsmDescription: FsmDescription
                }
            })();

            var myFsm = new quartz.FsmDescription(
                'NotSent',
                [
                    {
                        id: 0,
                        name: 'NotSent',
                        links: ['Processing']
                    },
                    {
                        id: 1,
                        name: 'Processing',
                        links: ['TradeCancelled', 'Complete'],
                        substates: ['BuildingMessage', 'SendingMessage', 'MessageSent', 'WaitToCancel'],
                        initialState: 'BuildingMessage'
                    },
                    {
                        id: 2,
                        name: 'BuildingMessage',
                        links: ['SendingMessage']
                    },
                    {
                        id: 3,
                        name: 'SendingMessage',
                        links: ['MessageSent', 'WaitToCancel']
                    },
                    {
                        id: 4,
                        name: 'MessageSent'
                    },
                    {
                        id: 5,
                        name: 'TradeCancelled'
                    },
                    {
                        id: 6,
                        name: 'Complete'
                    },
                    {
                        id: 7,
                        name: 'WaitToCancel',
                        links: ['TradeCancelled']
                    }
                ]
            );

            //graph.addCells(myFsm.getCells());
        </script>
    </body>
</html>