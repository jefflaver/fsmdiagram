<html>
    <head>
        <link rel="stylesheet" href="node_modules/jointjs/dist/joint.css" />
        <script src="node_modules/jquery/dist/jquery.js"></script>
        <script src="node_modules/lodash/index.js"></script>
        <script src="node_modules/backbone/backbone.js"></script>
        <script src="node_modules/jointjs/dist/joint.js"></script>
        <script src="node_modules/jointjs/dist/joint.shapes.fsa.js"></script>
        <script src="joint.shapes.quartz.js"></script>
    </head>
    <body>
        <div id="myholder"></div>
        <script type="text/javascript">

            function State(details) {
                this.name = details.name;
                this.entryActions = [];
                this.eventActions = {};
                this.exitActions = [];

                if(details.hasOwnProperty('entryActions')) {
                    this.entryActions = details.entryActions;
                }
                if(details.hasOwnProperty('eventActions')) {
                    this.eventActions = details.eventActions;
                }
                if(details.hasOwnProperty('exitActions')) {
                    this.exitActions = details.exitActions;
                }
            }

            function StateDiagram(initialState, states, links) {
                this.initialState = initialState;
                this.states = states;
                this.links = links;
            }
            StateDiagram.prototype.getStateByName = function(name) {
                for(var idx in this.states) {
                    if(this.states[idx].name === name) {
                        return this.states[idx];
                    }
                }
                return undefined;
            }
            StateDiagram.prototype.getConnectedStates = function(state) {
                var states = [];
                this.links.forEach(function(link) {
                    if(link.from === state.name) {
                        states.push(this.getStateByName(link.to));
                    }
                }, this);
                return states;
            }

            function SuperState(details, diagram) {
                State.call(this, details);
                this.diagram = diagram;
            }
            SuperState.prototype = Object.create(State.prototype);
            SuperState.prototype.SuperState = SuperState;

            function GridStateDiagram(initialState, states, links) {
                StateDiagram.call(this, initialState, states, links);
                
                this.grid = [];

                this.layoutStatesOntoGrid();
            }
            GridStateDiagram.prototype = Object.create(StateDiagram.prototype);
            GridStateDiagram.prototype.GridStateDiagram = GridStateDiagram;
            GridStateDiagram.prototype.findStateLocation = function(state) {
                for(var x in this.grid) {
                    for(var y in this.grid[x]) {
                        if(state == this.grid[x][y]) {
                            return {x: x, y: y};
                        }
                    }
                }
                return undefined;
            };
            GridStateDiagram.prototype.layoutStatesOntoGrid = function() {
                var states = [this.getStateByName(this.initialState)];
                var visited = new Set();

                while(states.length) {
                    var state = states.shift();

                    if(visited.has(state)) {
                        continue;
                    }
                    visited.add(state);

                    this.grid.push([]);
                    var loc = this.findStateLocation(state);
                    if(undefined !== loc) {
                        this.grid[loc.x].splice(loc.y, 1);
                    }
                    this.grid[this.grid.length - 1].push(state);

                    states = states.concat(this.getConnectedStates(state));
                }

                var loneStates = this.states.filter(function(state) {
                    return this.findStateLocation(state) === undefined;
                }, this);

                loneStates.forEach(function(state) {
                    var connectedStates = this.getConnectedStates(state);
                    var minX = this.grid.length;
                    connectedStates.forEach(function(connectedState) {
                        var loc = this.findStateLocation(connectedState);
                        if(loc !== undefined) {
                            minX = Math.min(minX, loc.x);
                        }
                    }, this);
                    if(this.grid.length !== minX) {
                        this.grid[Math.max(0, minX - 1)].push(state);
                    }
                }, this);

                // Adjust back a level, where necessary
                this.states.forEach(function(state) {
                    var connectedStates = this.getConnectedStates(state);
                    var loc = this.findStateLocation(state);
                    var newX = loc.x;
                    connectedStates.forEach(function(connectedState) {
                        var connectedLoc = this.findStateLocation(connectedState);
                        newX = Math.min(connectedLoc.x, loc.x);
                    }, this);
                    if(newX !== loc.x) {
                        this.grid[loc.x].splice(loc.y, 1);
                        this.grid[newX].push(state);
                    }
                }, this);

                this.grid = this.grid.filter(function(yGrid) {
                    return yGrid.length > 0;
                })
            };

            function actionTextCreator(prefix, actions) {
                var maxLength = 0;
                var actionText = "";

                actions.forEach(function(action, index) {
                    var text;
                    if(index > 0) {
                        text = "    ";
                    } else {
                        text = prefix + " / ";
                    }
                    text += action + "()\n";
                    maxLength = Math.max(maxLength, text.length);

                    actionText += text;
                });

                return {
                    text: actionText,
                    maxLength: maxLength
                };
            }

            const DEFAULT_STATE_WIDTH = 150;
            const DEFAULT_STATE_HEIGHT = 80;
            const TEXT_HEIGHT = 9;
            const TEXT_WIDTH = 7;

            function getRenderableStateInfo(state) {
                var actionText = "";
                var width = DEFAULT_STATE_WIDTH;
                var height = DEFAULT_STATE_HEIGHT;

                var actionTextInfo = actionTextCreator("entry", state.entryActions);
                actionText = actionTextInfo.text;

                height += Math.max(state.entryActions.length, 1) * TEXT_HEIGHT;
                width = Math.max(width, actionTextInfo.maxLength * TEXT_WIDTH);

                for(var event in state.eventActions) {
                    actionTextInfo = actionTextCreator(event, state.eventActions[event]);
                    actionText += actionTextInfo.text;

                    height += state.eventActions[event].length * TEXT_HEIGHT;
                    width = Math.max(width, actionTextInfo.maxLength * TEXT_WIDTH);
                }

                actionTextInfo = actionTextCreator("exit", state.exitActions);
                actionText += actionTextInfo.text;

                height += Math.max(state.exitActions.length, 1) * TEXT_HEIGHT;
                width = Math.max(width, actionTextInfo.maxLength * TEXT_WIDTH);

                return {
                    actionText: actionText,
                    width: width, 
                    height: height
                };
            }

            function getRenderableDiagram(gridDiagram) {
                var curX = 0;
                var renderableGrid = [];
                gridDiagram.grid.forEach(function(column) {
                    var curY = 0;
                    renderableGrid.push([]);
                    column.forEach(function(state) {
                        if(state instanceof SuperState) {

                        } else {
                            renderableGrid[renderableGrid.length - 1].push(
                                getRenderableStateInfo(state));
                        }
                    });
                });

                return renderableGrid;
            }

            function createStateJointJsElement(renderableState) {
                return new joint.shapes.quartz.State({
                    size: {
                        width: renderableState.width,
                        height: renderableState.height 
                    },
                    attrs: {
                        ".name": { text: renderableState.name },
                        ".actions": { text: renderableState.actionText }
                    }
                });
            }

            (function() {

                var ProcessingSuperState = new SuperState(
                    {
                        name: "Processing"
                    },
                    new StateDiagram(
                        "BuildingMessage",
                        [
                            new State({
                                name: "BuildingMessage"
                            }),
                            new State({
                                name: "SendingMessage"
                            }),
                            new State({
                                name: "MessageSent"
                            })
                        ],
                        [
                            {
                                from: "BuildingMessage",
                                to: "SendingMessage"
                            },
                            {
                                from: "SendingMessage",
                                to: "MessageSent"
                            }
                        ]
                    )
                );

                var TradeWorkflow = new GridStateDiagram(
                    "NotSent",
                    [
                        new State({
                            name: "NotSent"
                        }),
                        ProcessingSuperState,
                        new State({
                            name: "SetupIssue"
                        }),
                        new State({
                            name: "SomeState"
                        }),
                        new State({
                            name: "SomeOtherState"
                        })
                    ],
                    [
                        {
                            from: "NotSent",
                            to: "Processing"
                        },
                        {
                            from: "Processing",
                            to: "SetupIssue"
                        },
                        {
                            from: "SetupIssue",
                            to: "Processing"
                        },
                        {
                            from: "SomeState",
                            to: "Processing"
                        },
                        {
                            from: "SomeOtherState",
                            to: "NotSent"
                        }
                    ]
                );
                
                var graph = new joint.dia.Graph;
            
                var paper = new joint.dia.Paper({
                    el: $('#myholder'),
                    width: 1000,
                    height: 1000,
                    model: graph,
                    gridSize: 1
                });

                var myState = createStateJointJsElement(
                    getRenderableStateInfo(new State({
                        name: "NotSent",
                        entryActions: ["action1", "action2"],
                        eventActions: {
                            MessageSent: ["action3"],
                            MessageBuilt: ["anotherAction?"],
                            Limit: ["pushItTo!?"],
                            More: ["moremoremore"],
                            Uhoh: ["noooooo"],
                        },
                        exitActions: ["SomeOtherLongerAction"]
                    })));
                graph.addCell(myState);

                console.log(getRenderableDiagram(TradeWorkflow));
            })();

        </script>
    </body>
</html>